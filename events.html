<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EMERGE ‚Äì Events Calendar</title>

  <!-- FullCalendar (non-premium) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #222;
    }

    header {
      background: #004f9f;
      color: #fff;
      padding: 16px 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .header-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      background: #fff;
      padding: 6px;
      border-radius: 6px;
      height: 60px;
    }

    .header-text h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .header-text p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.95;
    }

    .wp-nav {
      background: #fff;
      padding: 10px 20px;
      margin: 0 auto 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      font-size: 0.9rem;
    }

    .wp-nav a {
      color: #004f9f;
      text-decoration: none;
      font-weight: 600;
      padding-bottom: 2px;
      border-bottom: 2px solid transparent;
    }

    .wp-nav a.active {
      border-bottom-color: #004f9f;
    }

    main {
      max-width: none;
      padding: 0 16px 40px;
    }

    #status {
      margin: 10px 0;
      font-size: 0.9rem;
      color: #555;
    }
    #status.error { color: #b00020; }

    .controls {
      display: flex;
      gap: 14px;
      align-items: center;
      margin-bottom: 10px;
      flex-wrap: wrap;
      font-size: 0.9rem;
      color: #444;
    }

    .legend {
      background: #fff;
      border-radius: 8px;
      padding: 10px 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 10px;
    }

    .legend-title {
      font-weight: 700;
      font-size: 0.95rem;
      margin: 0 0 8px 0;
      color: #222;
    }

    .legend-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px 12px;
      align-items: center;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      user-select: none;
      white-space: nowrap;
    }

    .swatch {
      width: 12px;
      height: 12px;
      border-radius: 3px;
      display: inline-block;
      border: 1px solid rgba(0,0,0,0.15);
      flex: 0 0 auto;
    }

    .legend-item input {
      transform: translateY(1px);
    }

    #calendar {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    /* === Holiday styling (distinct) === */
    .fc-event.cat-holiday,
    .fc-daygrid-event.cat-holiday,
    .fc-list-event.cat-holiday {
      background-color: #374151 !important;
      border-color: #374151 !important;
      color: #ffffff !important;
    }
    .fc-daygrid-event.cat-holiday .fc-event-title::before,
    .fc-timegrid-event.cat-holiday .fc-event-title::before,
    .fc-list-event.cat-holiday .fc-list-event-title a::before {
      content: "üèõ ";
    }

    /* === WP colouring ===
       We colour by WP-specific classNames we attach per source:
       src-wp1 ... src-wp9
    */
    .fc-event.src-wp1, .fc-daygrid-event.src-wp1, .fc-list-event.src-wp1 { background-color: #1d4ed8 !important; border-color: #1d4ed8 !important; color:#fff !important; }
    .fc-event.src-wp2, .fc-daygrid-event.src-wp2, .fc-list-event.src-wp2 { background-color: #047857 !important; border-color: #047857 !important; color:#fff !important; }
    .fc-event.src-wp3, .fc-daygrid-event.src-wp3, .fc-list-event.src-wp3 { background-color: #7c3aed !important; border-color: #7c3aed !important; color:#fff !important; }
    .fc-event.src-wp4, .fc-daygrid-event.src-wp4, .fc-list-event.src-wp4 { background-color: #b45309 !important; border-color: #b45309 !important; color:#fff !important; }
    .fc-event.src-wp5, .fc-daygrid-event.src-wp5, .fc-list-event.src-wp5 { background-color: #be123c !important; border-color: #be123c !important; color:#fff !important; }
    .fc-event.src-wp6, .fc-daygrid-event.src-wp6, .fc-list-event.src-wp6 { background-color: #0ea5e9 !important; border-color: #0ea5e9 !important; color:#fff !important; }
    .fc-event.src-wp7, .fc-daygrid-event.src-wp7, .fc-list-event.src-wp7 { background-color: #4b5563 !important; border-color: #4b5563 !important; color:#fff !important; }
    .fc-event.src-wp8, .fc-daygrid-event.src-wp8, .fc-list-event.src-wp8 { background-color: #16a34a !important; border-color: #16a34a !important; color:#fff !important; }
    .fc-event.src-wp9, .fc-daygrid-event.src-wp9, .fc-list-event.src-wp9 { background-color: #9333ea !important; border-color: #9333ea !important; color:#fff !important; }

    /* Keep event text readable in list view */
    .fc-list-event-title a { text-decoration: none; }

  </style>
</head>

<body>

<header>
  <div class="header-container">
    <img src="https://euemerge.eu/wp-content/uploads/2025/05/emerge_website.png"
         alt="EMERGE Logo"
         class="header-logo" />
    <div class="header-text">
      <h1>EMERGE ‚Äì Events Calendar</h1>
      <p>All Work Package events plus partner holidays</p>
    </div>
  </div>
</header>

<nav class="wp-nav">
  <a href="WP1.html">WP1</a>
  <a href="WP2.html">WP2</a>
  <a href="WP3.html">WP3</a>
  <a href="WP4.html">WP4</a>
  <a href="WP5.html">WP5</a>
  <a href="WP6.html">WP6</a>
  <a href="WP7.html">WP7</a>
  <a href="WP8.html">WP8</a>
  <a href="WP9.html">WP9</a>
  <span>|</span>
  <a href="events.html" class="active">Events</a>
</nav>

<main>
  <div id="status">Loading calendars‚Ä¶</div>

  <div class="controls">
    <label>
      <input type="checkbox" id="toggleHolidays" checked>
      Show holidays
    </label>
  </div>

  <div class="legend" id="legend">
    <p class="legend-title">Work Packages (toggle)</p>
    <div class="legend-grid" id="legendGrid"></div>
  </div>

  <div id="calendar"></div>
</main>

<script>
  const R2_BASE = 'https://pub-577ff589d29c4ebe9d2ea393dcf228f1.r2.dev';
  const HOLIDAYS_ICS_URL = `${R2_BASE}/holidays.ics`;

  // WP definitions: id, label, URL, className, swatch colour (must match CSS colours)
  const WP_DEFS = [
    { id: 'wp1', label: 'WP1', url: `${R2_BASE}/wp1.ics`, className: 'src-wp1', color: '#1d4ed8' },
    { id: 'wp2', label: 'WP2', url: `${R2_BASE}/wp2.ics`, className: 'src-wp2', color: '#047857' },
    { id: 'wp3', label: 'WP3', url: `${R2_BASE}/wp3.ics`, className: 'src-wp3', color: '#7c3aed' },
    { id: 'wp4', label: 'WP4', url: `${R2_BASE}/wp4.ics`, className: 'src-wp4', color: '#b45309' },
    { id: 'wp5', label: 'WP5', url: `${R2_BASE}/wp5.ics`, className: 'src-wp5', color: '#be123c' },
    { id: 'wp6', label: 'WP6', url: `${R2_BASE}/wp6.ics`, className: 'src-wp6', color: '#0ea5e9' },
    { id: 'wp7', label: 'WP7', url: `${R2_BASE}/wp7.ics`, className: 'src-wp7', color: '#4b5563' },
    { id: 'wp8', label: 'WP8', url: `${R2_BASE}/wp8.ics`, className: 'src-wp8', color: '#16a34a' },
    { id: 'wp9', label: 'WP9', url: `${R2_BASE}/wp9.ics`, className: 'src-wp9', color: '#9333ea' },
  ];

  const statusEl = document.getElementById('status');

  function setError(msg) {
    statusEl.textContent = msg;
    statusEl.classList.add('error');
  }

  // Minimal ICS parser (same approach as your other pages)
  function parseICS(text) {
    const lines = text.split(/\r?\n/);
    const events = [];
    let cur = null;

    for (const l of lines) {
      if (l === 'BEGIN:VEVENT') { cur = {}; continue; }
      if (l === 'END:VEVENT') { if (cur) events.push(cur); cur = null; continue; }
      if (!cur) continue;

      const idx = l.indexOf(':');
      if (idx === -1) continue;

      const key = l.slice(0, idx).split(';')[0];
      const val = l.slice(idx + 1);

      if (key === 'SUMMARY') cur.title = val;
      if (key === 'DESCRIPTION') cur.description = val.replace(/\\n/g, '\n');
      if (key === 'LOCATION') cur.location = val;
      if (key === 'DTSTART') cur.start = val;
      if (key === 'DTEND') cur.end = val;
    }

    function parseTime(v) {
      if (!v) return null;
      // all-day (YYYYMMDD)
      if (v.length === 8 && !v.includes('T')) {
        const y = parseInt(v.slice(0,4), 10);
        const m = parseInt(v.slice(4,6), 10) - 1;
        const d = parseInt(v.slice(6,8), 10);
        return { date: new Date(y, m, d), allDay: true };
      }
      // naive datetime support (YYYYMMDDTHHMM...)
      const y = parseInt(v.slice(0,4), 10);
      const m = parseInt(v.slice(4,6), 10) - 1;
      const d = parseInt(v.slice(6,8), 10);
      const hh = parseInt(v.slice(9,11) || '0', 10);
      const mm = parseInt(v.slice(11,13) || '0', 10);
      const ss = parseInt(v.slice(13,15) || '0', 10);

      // 'Z' handling (UTC)
      if (v.endsWith('Z')) {
        return { date: new Date(Date.UTC(y, m, d, hh, mm, ss)), allDay: false };
      }
      return { date: new Date(y, m, d, hh, mm, ss), allDay: false };
    }

    return events.map(e => {
      const s = parseTime(e.start);
      const en = parseTime(e.end);

      return {
        title: e.title || '(no title)',
        start: s?.date,
        end: en?.date,
        allDay: s?.allDay,
        extendedProps: {
          description: e.description || '',
          location: e.location || ''
        }
      };
    }).filter(e => e.start);
  }

  const calendar = new FullCalendar.Calendar(document.getElementById('calendar'), {
    initialView: 'listYear',
    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek,listYear'
    }
  });

  calendar.render();

  // --- Event source refs (for toggling) ---
  const wpSourcesById = new Map();     // id -> source object
  let holidaysSource = null;

  async function loadICS(url, className) {
    const r = await fetch(url);
    if (!r.ok) throw new Error(`HTTP ${r.status} for ${url}`);
    const events = parseICS(await r.text());
    events.forEach(e => e.classNames = (e.classNames || []).concat([className]));
    return events;
  }

  function addWpSource(def, events) {
    const src = { id: def.id, events };
    wpSourcesById.set(def.id, src);
    calendar.addEventSource(src);
  }

  function removeWpSource(defId) {
    const src = calendar.getEventSourceById(defId);
    if (src) src.remove();
  }

  function buildLegend() {
    const legendGrid = document.getElementById('legendGrid');

    for (const def of WP_DEFS) {
      const row = document.createElement('label');
      row.className = 'legend-item';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = true;
      cb.dataset.wpId = def.id;

      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = def.color;

      const txt = document.createElement('span');
      txt.textContent = def.label;

      row.appendChild(cb);
      row.appendChild(sw);
      row.appendChild(txt);
      legendGrid.appendChild(row);

      cb.addEventListener('change', (e) => {
        const id = e.target.dataset.wpId;
        if (e.target.checked) {
          // Re-add from cached events
          const cached = wpSourcesById.get(id);
          if (cached) {
            // only add if not already present
            const existing = calendar.getEventSourceById(id);
            if (!existing) calendar.addEventSource(cached);
          } else {
            // If not loaded/cached (e.g., previously failed), try load now
            const def = WP_DEFS.find(x => x.id === id);
            if (!def) return;
            statusEl.textContent = `Loading ${def.label}‚Ä¶`;
            loadICS(def.url, def.className).then(events => {
              addWpSource(def, events);
              statusEl.textContent = `${def.label} loaded (${events.length} events).`;
            }).catch(err => {
              console.error(err);
              setError(`Failed to load ${def.label}.`);
              e.target.checked = false;
            });
          }
        } else {
          removeWpSource(id);
        }
      });
    }
  }

  buildLegend();

  async function loadAll() {
    statusEl.classList.remove('error');
    statusEl.textContent = 'Loading WP events and holidays‚Ä¶';

    let totalWpEvents = 0;
    const wpFailures = [];

    const wpLoads = await Promise.allSettled(
      WP_DEFS.map(def => loadICS(def.url, def.className))
    );

    wpLoads.forEach((res, idx) => {
      const def = WP_DEFS[idx];
      if (res.status === 'fulfilled') {
        addWpSource(def, res.value);
        totalWpEvents += res.value.length;
      } else {
        wpFailures.push(def.label);
        console.error(`Failed to load ${def.label}`, res.reason);
        // Reflect failure in legend checkbox
        const cb = document.querySelector(`input[type="checkbox"][data-wp-id="${def.id}"]`);
        if (cb) cb.checked = false;
      }
    });

    // Holidays
    try {
      const holEvents = await loadICS(HOLIDAYS_ICS_URL, 'cat-holiday');
      holidaysSource = { id: 'holidays', events: holEvents };
      calendar.addEventSource(holidaysSource);

      statusEl.textContent =
        `Loaded ${totalWpEvents} WP events + ${holEvents.length} holidays` +
        (wpFailures.length ? ` (failed: ${wpFailures.join(', ')})` : '');
    } catch (e) {
      console.error('Failed to load holidays', e);
      setError(`Loaded ${totalWpEvents} WP events but could not load holidays.`);
      document.getElementById('toggleHolidays').checked = false;
    }
  }

  // Holidays toggle
  document.getElementById('toggleHolidays').addEventListener('change', e => {
    const src = calendar.getEventSourceById('holidays');
    if (e.target.checked) {
      if (!src && holidaysSource) calendar.addEventSource(holidaysSource);
    } else {
      if (src) src.remove();
    }
  });

  loadAll();
</script>

</body>
</html>
