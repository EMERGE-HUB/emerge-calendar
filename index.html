<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EMERGE – Calendar Hub</title>

  <!-- FullCalendar (free) -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <style>
    :root{
      --emerge-blue:#004f9f;
      --emerge-mint:#bfeee6;
      --emerge-mint-soft:#e6faf6;

      /* Weekend shading */
      --weekend:#f0f2f5;

      --text:#111827;
      --muted:#4b5563;
      --card:#ffffff;
      --bg:#f5f7fb;
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      background: var(--emerge-blue);
      color:#fff;
      padding:16px 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .header-container{
      display:flex;
      align-items:center;
      gap:16px;
    }

    .header-logo{
      background:#ffffff;
      padding:6px;
      border-radius:6px;
      height:60px;
    }

    .header-text h1{ margin:0; font-size:1.3rem; }
    .header-text p{ margin:4px 0 0; font-size:0.9rem; opacity:0.95; }

    main{
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 12px 40px;
    }

    .card{
      background: var(--card);
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.02);
      margin-bottom: 12px;
    }

    #status{
      margin: 0 0 10px;
      font-size: 0.9rem;
      color: var(--muted);
    }
    #status.error{ color:#b00020; }

    .controls{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 14px;
      align-items:center;
      justify-content:space-between;
    }

    .toggles{
      display:flex;
      flex-wrap:wrap;
      gap: 10px 14px;
      align-items:center;
    }

    .toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      font-size:0.92rem;
      color: var(--text);
    }

    .toggle input{ transform: translateY(1px); }

    .swatch{
      width: 12px;
      height: 12px;
      border-radius: 3px;
      border: 1px solid rgba(0,0,0,0.2);
      flex: 0 0 auto;
    }

    .actions{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
    }

    .btn{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #cfd6e4;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      color: #111827;
      text-decoration:none;
    }
    .btn:hover{ background:#e5e7eb; }

    #calendar{
      background: var(--card);
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.02);
    }

    /* ===== Weekend shading (reliable, CSS-based) ===== */
    .fc .fc-daygrid-day.fc-day-sat,
    .fc .fc-daygrid-day.fc-day-sun{
      background: var(--weekend);
    }

    .fc .fc-timegrid-col.fc-day-sat,
    .fc .fc-timegrid-col.fc-day-sun{
      background: var(--weekend);
    }

    .fc .fc-timegrid-col.fc-day-sat .fc-timegrid-col-frame,
    .fc .fc-timegrid-col.fc-day-sun .fc-timegrid-col-frame{
      background: var(--weekend);
    }

    .fc .fc-multimonth-daygrid.fc-day-sat,
    .fc .fc-multimonth-daygrid.fc-day-sun{
      background: var(--weekend);
    }

    /* ===== Hover behaviour fix (list view) ===== */
    .fc .fc-list-event:hover td{
      background: var(--emerge-mint-soft) !important;
    }
    .fc .fc-list-event-title a{ color: var(--text); text-decoration:none; }
    .fc .fc-list-event-title a:hover{ text-decoration:underline; }

    /* ===== Source-based colouring (foreground WP events) ===== */
    .fc-event.src-wp1, .fc-daygrid-event.src-wp1, .fc-list-event.src-wp1 { background:#1f4e99 !important; border-color:#1f4e99 !important; color:#fff !important; }
    .fc-event.src-wp2, .fc-daygrid-event.src-wp2, .fc-list-event.src-wp2 { background:#6b21a8 !important; border-color:#6b21a8 !important; color:#fff !important; }
    .fc-event.src-wp3, .fc-daygrid-event.src-wp3, .fc-list-event.src-wp3 { background:#0f766e !important; border-color:#0f766e !important; color:#fff !important; }
    .fc-event.src-wp4, .fc-daygrid-event.src-wp4, .fc-list-event.src-wp4 { background:#b45309 !important; border-color:#b45309 !important; color:#fff !important; }
    .fc-event.src-wp5, .fc-daygrid-event.src-wp5, .fc-list-event.src-wp5 { background:#0f172a !important; border-color:#0f172a !important; color:#fff !important; }
    .fc-event.src-wp6, .fc-daygrid-event.src-wp6, .fc-list-event.src-wp6 { background:#1d4ed8 !important; border-color:#1d4ed8 !important; color:#fff !important; }
    .fc-event.src-wp7, .fc-daygrid-event.src-wp7, .fc-list-event.src-wp7 { background:#be123c !important; border-color:#be123c !important; color:#fff !important; }
    .fc-event.src-wp8, .fc-daygrid-event.src-wp8, .fc-list-event.src-wp8 { background:#2e7d32 !important; border-color:#2e7d32 !important; color:#fff !important; }
    .fc-event.src-wp9, .fc-daygrid-event.src-wp9, .fc-list-event.src-wp9 { background:#374151 !important; border-color:#374151 !important; color:#fff !important; }

    /* ===== List view readability fix (soft mint hover) ===== */
    .fc .fc-list-event td,
    .fc .fc-list-event .fc-list-event-title,
    .fc .fc-list-event .fc-list-event-title a,
    .fc .fc-list-event .fc-list-event-time{
      color: inherit !important;
      opacity: 1 !important;
    }

    .fc .fc-list-event:hover td,
    .fc .fc-list-event:hover .fc-list-event-title,
    .fc .fc-list-event:hover .fc-list-event-title a,
    .fc .fc-list-event:hover .fc-list-event-time{
      color: var(--emerge-mint-soft) !important;
    }

    /* Dark WPs => white text (non-hover baseline) */
    .fc .fc-list-event.src-wp1 td,
    .fc .fc-list-event.src-wp2 td,
    .fc .fc-list-event.src-wp3 td,
    .fc .fc-list-event.src-wp4 td,
    .fc .fc-list-event.src-wp5 td,
    .fc .fc-list-event.src-wp6 td,
    .fc .fc-list-event.src-wp7 td,
    .fc .fc-list-event.src-wp8 td,
    .fc .fc-list-event.src-wp9 td{
      color:#fff !important;
    }

    /* Match list-row backgrounds to WP colours */
    .fc .fc-list-event.src-wp1 td{ background:#1f4e99 !important; border-color:#1f4e99 !important; }
    .fc .fc-list-event.src-wp2 td{ background:#6b21a8 !important; border-color:#6b21a8 !important; }
    .fc .fc-list-event.src-wp3 td{ background:#0f766e !important; border-color:#0f766e !important; }
    .fc .fc-list-event.src-wp4 td{ background:#b45309 !important; border-color:#b45309 !important; }
    .fc .fc-list-event.src-wp5 td{ background:#0f172a !important; border-color:#0f172a !important; }
    .fc .fc-list-event.src-wp6 td{ background:#1d4ed8 !important; border-color:#1d4ed8 !important; }
    .fc .fc-list-event.src-wp7 td{ background:#be123c !important; border-color:#be123c !important; }
    .fc .fc-list-event.src-wp8 td{ background:#2e7d32 !important; border-color:#2e7d32 !important; }
    .fc .fc-list-event.src-wp9 td{ background:#374151 !important; border-color:#374151 !important; }

    /* Background shading entries (holidays) */
    .fc .fc-bg-event{
      opacity: 1 !important;
    }

    /* ===== Grid view: show time after title (muted) ===== */
    .fc-event-time-inline{
      opacity: 0.82;
      font-weight: 600;
    }
  </style>
</head>

<body>
<header>
  <div class="header-container">
    <img src="https://euemerge.eu/wp-content/uploads/2025/05/emerge_website.png" alt="EMERGE Logo" class="header-logo" />
    <div class="header-text">
      <h1>EMERGE Calendar Hub</h1>
      <p>Toggle Work Packages + shaded weekends + shaded partner holidays</p>
    </div>
  </div>
</header>

<main>
  <div id="status">Loading…</div>

  <div class="card">
    <div class="controls">
      <div class="toggles" id="toggles"></div>
      <div class="actions">
        <button class="btn" id="selectAllBtn" type="button">Select all</button>
        <button class="btn" id="selectNoneBtn" type="button">Select none</button>
        <button class="btn" id="copyLinkBtn" type="button">Copy link</button>
      </div>
    </div>
  </div>

  <div id="calendar"></div>
</main>

<script>
  // ============================================================
  // CONFIG
  // ============================================================
  const BASE_ICS = 'https://pub-577ff589d29c4ebe9d2ea393dcf228f1.r2.dev/';

  // Toggleable sources (ONLY WPs)
  const WP_SOURCES = [
    { key: 'wp1', label: 'WP1', url: BASE_ICS + 'wp1.ics', className: 'src-wp1', color: '#1f4e99' },
    { key: 'wp2', label: 'WP2', url: BASE_ICS + 'wp2.ics', className: 'src-wp2', color: '#6b21a8' },
    { key: 'wp3', label: 'WP3', url: BASE_ICS + 'wp3.ics', className: 'src-wp3', color: '#0f766e' },
    { key: 'wp4', label: 'WP4', url: BASE_ICS + 'wp4.ics', className: 'src-wp4', color: '#b45309' },
    { key: 'wp5', label: 'WP5', url: BASE_ICS + 'wp5.ics', className: 'src-wp5', color: '#0f172a' },
    { key: 'wp6', label: 'WP6', url: BASE_ICS + 'wp6.ics', className: 'src-wp6', color: '#1d4ed8' },
    { key: 'wp7', label: 'WP7', url: BASE_ICS + 'wp7.ics', className: 'src-wp7', color: '#be123c' },
    { key: 'wp8', label: 'WP8', url: BASE_ICS + 'wp8.ics', className: 'src-wp8', color: '#2e7d32' },
    { key: 'wp9', label: 'WP9', url: BASE_ICS + 'wp9.ics', className: 'src-wp9', color: '#374151' },
  ];

  // Always-on background shading (NO tickbox)
  const HOLIDAYS_SOURCE = {
    key: 'holidays',
    label: 'Holidays',
    url: BASE_ICS + 'holidays.ics',
    color: getComputedStyle(document.documentElement).getPropertyValue('--emerge-mint').trim() || '#bfeee6'
  };

  const STORAGE_KEY = 'emergeCalendarHubSelection_wpOnly_v1';

  // ============================================================
  // OPTION: show time after title in month + multiMonth grid views
  // ============================================================
  const SHOW_TIME_IN_GRID = true; // set false to disable

  function escapeHtml(s) {
    return String(s ?? '')
      .replace(/&/g,'&amp;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/"/g,'&quot;')
      .replace(/'/g,'&#39;');
  }

  function gridEventContent(arg) {
    // Only apply to dayGrid + multiMonth views (month + year grid)
    const isGrid = arg.view.type.startsWith('dayGrid') || arg.view.type.startsWith('multiMonth');
    if (!isGrid || !SHOW_TIME_IN_GRID) return true;

    // arg.timeText is already formatted per FullCalendar
    const time = arg.timeText
      ? `<span class="fc-event-time-inline"> ${escapeHtml(arg.timeText)}</span>`
      : '';

    return {
      html: `<div class="fc-event-title">${escapeHtml(arg.event.title)}${time}</div>`
    };
  }

  // ============================================================
  // ICS PARSER (simple, good enough for planner-style ICS)
  // ============================================================
  function parseICS(icsText) {
    const rawLines = icsText.split(/\r?\n/);
    const lines = [];

    // Unfold lines
    for (const line of rawLines) {
      if (!line) continue;
      if (line.startsWith(' ') || line.startsWith('\t')) {
        if (lines.length > 0) lines[lines.length - 1] += line.slice(1);
      } else {
        lines.push(line);
      }
    }

    const vevents = [];
    let current = null;

    for (const line of lines) {
      if (line.startsWith('BEGIN:VEVENT')) { current = {}; continue; }
      if (line.startsWith('END:VEVENT')) { if (current) vevents.push(current); current = null; continue; }
      if (!current) continue;

      const parts = line.split(':');
      if (parts.length < 2) continue;

      const value = parts.slice(1).join(':');
      const keyWithParams = parts[0];
      const key = keyWithParams.split(';')[0].toUpperCase();

      if (key === 'SUMMARY') current.summary = value;
      if (key === 'DESCRIPTION') current.description = value.replace(/\\n/g, '\n');
      if (key === 'LOCATION') current.location = value;
      if (key === 'DTSTART') current.dtstart = value;
      if (key === 'DTEND') current.dtend = value;
    }

    function parseICSTime(v) {
      if (!v) return null;

      // All-day date (YYYYMMDD)
      if (v.length === 8 && !v.includes('T')) {
        const y = parseInt(v.slice(0,4), 10);
        const m = parseInt(v.slice(4,6), 10) - 1;
        const d = parseInt(v.slice(6,8), 10);
        return { date: new Date(Date.UTC(y, m, d)), allDay: true };
      }

      // Date-time (YYYYMMDDTHHMMSS[Z])
      const y = parseInt(v.slice(0,4), 10);
      const m = parseInt(v.slice(4,6), 10) - 1;
      const d = parseInt(v.slice(6,8), 10);
      const hh = parseInt(v.slice(9,11) || '0', 10);
      const mm = parseInt(v.slice(11,13) || '0', 10);
      const ss = parseInt(v.slice(13,15) || '0', 10);

      if (v.endsWith('Z')) return { date: new Date(Date.UTC(y, m, d, hh, mm, ss)), allDay: false };
      return { date: new Date(y, m, d, hh, mm, ss), allDay: false };
    }

    const events = vevents.map(ev => {
      const startParsed = parseICSTime(ev.dtstart);
      const endParsed = parseICSTime(ev.dtend);
      const allDay = startParsed ? startParsed.allDay : false;

      return {
        title: ev.summary || '(no title)',
        start: startParsed ? startParsed.date : null,
        end: endParsed ? endParsed.date : null,
        allDay: allDay,
        extendedProps: {
          description: ev.description || '',
          location: ev.location || ''
        }
      };
    });

    return events.filter(e => e.start);
  }

  // ============================================================
  // Selection state: URL -> localStorage -> default all-on
  // ============================================================
  function getSelectionFromUrl() {
    const params = new URLSearchParams(window.location.search);
    const wpsParam = params.get('wps');
    if (wpsParam === null) return null;

    const selected = new Set();
    const wpKeys = WP_SOURCES.map(s => s.key);

    const norm = wpsParam.trim().toLowerCase();
    if (norm === 'all') {
      wpKeys.forEach(k => selected.add(k));
    } else if (norm === 'none') {
      // none
    } else {
      norm.split(',').map(x => x.trim()).filter(Boolean).forEach(k => selected.add(k));
    }
    return selected;
  }

  function getSelectionFromStorage() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      if (!obj || !Array.isArray(obj.selected)) return null;
      return new Set(obj.selected);
    } catch {
      return null;
    }
  }

  function saveSelectionToStorage(selectedSet) {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      selected: Array.from(selectedSet),
      savedAt: new Date().toISOString()
    }));
  }

  function defaultSelection() {
    return new Set(WP_SOURCES.map(s => s.key));
  }

  // ============================================================
  // UI: toggles (WPs only)
  // ============================================================
  function renderToggles(selected) {
    const togglesEl = document.getElementById('toggles');
    togglesEl.innerHTML = '';

    for (const src of WP_SOURCES) {
      const label = document.createElement('label');
      label.className = 'toggle';

      const cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.checked = selected.has(src.key);
      cb.dataset.key = src.key;

      const sw = document.createElement('span');
      sw.className = 'swatch';
      sw.style.background = src.color;

      const txt = document.createElement('span');
      txt.textContent = src.label;

      label.appendChild(cb);
      label.appendChild(sw);
      label.appendChild(txt);

      togglesEl.appendChild(label);
    }
  }

  // ============================================================
  // FullCalendar + sources
  // ============================================================
  document.addEventListener('DOMContentLoaded', async function() {
    const statusEl = document.getElementById('status');
    const calendarEl = document.getElementById('calendar');

    function setError(msg) {
      statusEl.textContent = msg;
      statusEl.classList.add('error');
    }
    function clearError() {
      statusEl.classList.remove('error');
    }

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listYear',
      customButtons: {
        timeline: {
          text: 'Timeline',
          click: function() {
            const sel = getSelectionFromStorage() || defaultSelection();
            const wps = Array.from(sel).sort();

            const params = new URLSearchParams();
            params.set('wps', wps.length ? wps.join(',') : 'none');

            window.location.href = 'timeline.html?' + params.toString();
          }
        }
      },
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek,listYear,multiMonthYear,timeline'
      },
      views: {
        listYear: { buttonText: 'Year list' },
        multiMonthYear: { buttonText: 'Year grid' }
      },

      // >>> KEY: time after title in grid views
      eventContent: gridEventContent
    });

    calendar.render();

    const fromUrl = getSelectionFromUrl();
    const fromStorage = getSelectionFromStorage();
    const selected = fromUrl || fromStorage || defaultSelection();

    saveSelectionToStorage(selected);
    renderToggles(selected);

    const cache = new Map();            // key -> events[]
    const activeSourceIds = new Map();  // key -> sourceId

    async function fetchAndCacheIcs(url, cacheKey) {
      if (cache.has(cacheKey)) return cache.get(cacheKey);

      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(cacheKey + ': HTTP ' + resp.status);

      const text = await resp.text();
      const events = parseICS(text);

      cache.set(cacheKey, events);
      return events;
    }

    function addWpSource(key, def, events) {
      if (activeSourceIds.has(key)) return;
      const id = 'src-' + key;

      const wpEvents = (events || []).map(e => {
        const existing = Array.isArray(e.className) ? e.className : (e.className ? [e.className] : []);
        return { ...e, className: existing.concat([def.className]) };
      });

      calendar.addEventSource({ id, events: wpEvents });
      activeSourceIds.set(key, id);
    }

    function removeSource(key) {
      const id = activeSourceIds.get(key);
      if (!id) return;
      const src = calendar.getEventSourceById(id);
      if (src) src.remove();
      activeSourceIds.delete(key);
    }

    function updateStatus() {
      const wpParts = [];
      for (const key of activeSourceIds.keys()) {
        if (key === 'holidays') continue;
        const def = WP_SOURCES.find(s => s.key === key);
        const label = def ? def.label : key;
        const n = cache.get(key)?.length;
        wpParts.push(typeof n === 'number' ? `${label} (${n})` : label);
      }

      const holN = cache.get('holidays')?.length;
      const holTxt = typeof holN === 'number' ? `Holidays (${holN})` : 'Holidays';

      if (!wpParts.length) {
        statusEl.textContent = `No WP feeds selected. ${holTxt} loaded in background.`;
      } else {
        statusEl.textContent = `Loaded: ${wpParts.join(' + ')}. ${holTxt} loaded in background.`;
      }
    }

    async function loadHolidaysAlwaysOn() {
      try {
        const holEvents = await fetchAndCacheIcs(HOLIDAYS_SOURCE.url, 'holidays');

        const bgEvents = holEvents.map(e => ({
          start: e.start,
          end: e.end,
          allDay: true,
          display: 'background',
          backgroundColor: HOLIDAYS_SOURCE.color,
          title: e.title,
          extendedProps: { isHoliday: true }
        }));

        const id = 'src-holidays';
        calendar.addEventSource({ id, events: bgEvents });
        activeSourceIds.set('holidays', id);
      } catch (e) {
        console.error(e);
        setError('Holidays feed failed to load (see console).');
      }
    }

    async function applySelection(nextSelected) {
      clearError();
      statusEl.textContent = 'Loading selected feeds…';

      // Remove WPs turned off
      for (const key of Array.from(activeSourceIds.keys())) {
        if (key === 'holidays') continue;
        if (!nextSelected.has(key)) removeSource(key);
      }

      // Add WPs turned on
      for (const key of Array.from(nextSelected.keys())) {
        if (activeSourceIds.has(key)) continue;

        const def = WP_SOURCES.find(s => s.key === key);
        if (!def) continue;

        try {
          const events = await fetchAndCacheIcs(def.url, key);
          addWpSource(key, def, events);
        } catch (e) {
          console.error(e);
          setError('One or more WP feeds failed to load (see console).');
        }
      }

      updateStatus();
      saveSelectionToStorage(nextSelected);
    }

    // Always-on holidays first
    await loadHolidaysAlwaysOn();

    // Initial WP load
    await applySelection(selected);

    // UI events
    document.getElementById('toggles').addEventListener('change', async () => {
      const checks = Array.from(document.querySelectorAll('#toggles input[type="checkbox"]'));
      const next = new Set(checks.filter(c => c.checked).map(c => c.dataset.key));
      await applySelection(next);
    });

    document.getElementById('selectAllBtn').addEventListener('click', async () => {
      const next = new Set(WP_SOURCES.map(s => s.key));
      renderToggles(next);
      await applySelection(next);
    });

    document.getElementById('selectNoneBtn').addEventListener('click', async () => {
      const next = new Set();
      renderToggles(next);
      await applySelection(next);
    });

    document.getElementById('copyLinkBtn').addEventListener('click', async () => {
      const sel = getSelectionFromStorage() || defaultSelection();
      const wps = Array.from(sel).sort();

      const params = new URLSearchParams();
      params.set('wps', wps.length ? wps.join(',') : 'none');

      const url = window.location.origin + window.location.pathname + '?' + params.toString();

      try {
        await navigator.clipboard.writeText(url);
        statusEl.textContent = 'Link copied: ' + url;
        clearError();
      } catch {
        window.prompt('Copy this link:', url);
      }
    });
  });
</script>

</body>
</html>
