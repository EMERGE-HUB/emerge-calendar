<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EMERGE ‚Äì WP1 Calendar</title>

  <!-- FullCalendar Non-Premium -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.19/index.global.min.js"></script>

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f5f7fb;
      color: #222;
    }

    header {
      background: #004f9f;
      color: #fff;
      padding: 16px 24px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    .header-container {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .header-logo {
      background: #ffffff;
      padding: 6px;
      border-radius: 6px;
      height: 60px;
    }

    .header-text h1 {
      margin: 0;
      font-size: 1.3rem;
    }

    .header-text p {
      margin: 4px 0 0;
      font-size: 0.9rem;
      opacity: 0.95;
    }

    main {
      max-width: 1100px;
      margin: 24px auto;
      padding: 0 12px 40px;
    }

    #status {
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #555;
    }

    #status.error {
      color: #b00020;
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 14px;
      align-items: center;
      margin: 8px 0 12px;
      font-size: 0.9rem;
      color: #444;
    }

    .btn {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      background: #f3f4f6;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
      text-decoration: none;
      color: #222;
    }

    .btn:hover {
      background: #e5e7eb;
    }

    #calendar {
      background: #fff;
      border-radius: 8px;
      padding: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
    }

    .wp-nav {
      background: #ffffff;
      padding: 10px 20px;
      margin: 0 auto 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.15);
      font-size: 0.9rem;
    }

    .wp-nav a {
      color: #004f9f;
      text-decoration: none;
      font-weight: 600;
      padding-bottom: 2px;
      border-bottom: 2px solid transparent;
    }

    .wp-nav a:hover {
      text-decoration: underline;
    }

    .wp-nav a.active {
      border-bottom-color: #004f9f;
      text-decoration: none;
    }

    .wp-nav .divider {
      color: #666;
      margin: 0 6px;
      font-weight: 600;
    }

    /* ========= CATEGORY COLOURING =========
       Depends on [Label] prefix in SUMMARY, e.g. [Deliverable] Title
    */

    .fc-event.cat-deliverable,
    .fc-daygrid-event.cat-deliverable,
    .fc-list-event.cat-deliverable {
      background-color: #009688 !important;
      border-color: #009688 !important;
      color: #ffffff !important;
    }

    .fc-event.cat-milestone,
    .fc-daygrid-event.cat-milestone,
    .fc-list-event.cat-milestone {
      background-color: #ffb300 !important;
      border-color: #ffb300 !important;
      color: #000000 !important;
    }

    .fc-event.cat-meeting,
    .fc-daygrid-event.cat-meeting,
    .fc-list-event.cat-meeting {
      background-color: #2e7d32 !important;
      border-color: #2e7d32 !important;
      color: #ffffff !important;
    }

    .fc-event.cat-task,
    .fc-daygrid-event.cat-task,
    .fc-list-event.cat-task {
      background-color: #6a1b9a !important;
      border-color: #6a1b9a !important;
      color: #ffffff !important;
    }

    .fc-event.cat-event,
    .fc-daygrid-event.cat-event,
    .fc-list-event.cat-event {
      background-color: #c62828 !important;
      border-color: #c62828 !important;
      color: #ffffff !important;
    }

    .fc-event.cat-project-task,
    .fc-daygrid-event.cat-project-task,
    .fc-list-event.cat-project-task {
      background-color: #ef6c00 !important;
      border-color: #ef6c00 !important;
      color: #ffffff !important;
    }

    .fc-event.cat-other,
    .fc-daygrid-event.cat-other,
    .fc-list-event.cat-other {
      background-color: #607d8b !important;
      border-color: #607d8b !important;
      color: #ffffff !important;
    }


    /* ========= HOLIDAYS ========= */
    .fc-event.cat-holiday,
    .fc-daygrid-event.cat-holiday,
    .fc-list-event.cat-holiday {
      background-color: #374151 !important;
      border-color: #374151 !important;
      color: #ffffff !important;
    }

    .fc-daygrid-event.cat-holiday .fc-event-title::before,
    .fc-timegrid-event.cat-holiday .fc-event-title::before,
    .fc-list-event.cat-holiday .fc-list-event-title a::before {
      content: "üèõ ";
    }
/* List view uses table cells; keep holiday row colour on hover */
.fc .fc-list-event.cat-holiday td,
.fc .fc-list-event.cat-holiday:hover td {
  background-color: #374151 !important;
  color: #ffffff !important;
}

.fc .fc-list-event.cat-holiday .fc-list-event-title a,
.fc .fc-list-event.cat-holiday:hover .fc-list-event-title a {
  color: #ffffff !important;
}

    /* Modal */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.2s ease, visibility 0.2s ease;
      z-index: 9999;
    }

    .modal-backdrop.show {
      visibility: visible;
      opacity: 1;
    }

    .modal {
      background: #fff;
      border-radius: 10px;
      max-width: 520px;
      width: 92%;
      padding: 20px 22px 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.25);
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .modal-title {
      font-size: 1.05rem;
      font-weight: 600;
      margin: 0;
    }

    .modal-close {
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      line-height: 1;
    }

    .modal-body p {
      margin: 4px 0;
      font-size: 0.9rem;
    }

    .modal-body p span.label {
      font-weight: 600;
    }

    .modal-footer {
      margin-top: 12px;
      text-align: right;
    }

    @media (max-width: 600px) {
      .header-text h1 { font-size: 1.1rem; }
    }
  </style>
</head>

<body>

<header>
  <div class="header-container">
    <img src="https://euemerge.eu/wp-content/uploads/2025/05/emerge_website.png"
         alt="EMERGE Logo"
         class="header-logo" />

    <div class="header-text">
      <h1>EMERGE ‚Äì WP1 Calendar</h1>
      <p>Key activities for Work Package 1</p>
    </div>
  </div>
</header>

<nav class="wp-nav">
  <a href="WP1.html">WP1</a>
  <a href="WP2.html">WP2</a>
  <a href="WP3.html">WP3</a>
  <a href="WP4.html">WP4</a>
  <a href="WP5.html">WP5</a>
  <a href="WP6.html">WP6</a>
  <a href="WP7.html">WP7</a>
  <a href="WP8.html">WP8</a>
  <a href="WP9.html">WP9</a>

  <span class="divider">|</span>

  <a href="events.html">Events</a>
  <a href="meetings.html">Meetings</a>
  <a href="meetings-events.html">Meetings &amp; Events</a>
  <a href="all.html">All</a>
</nav>

<main>
  <div id="status">Loading WP1 calendar‚Ä¶</div>

  <div class="controls">
    <label>
      <input type="checkbox" id="toggleHolidays" checked>
      Show holidays
    </label>

    <a class="btn" href="timeline-WP1.html">Timeline view</a>
  </div>

  <div id="calendar"></div>
</main>

<!-- Event detail modal -->
<div id="eventModalBackdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle"></h2>
      <button class="modal-close" id="modalCloseBtn" aria-label="Close">&times;</button>
    </div>
    <div class="modal-body">
      <p><span class="label">When:</span> <span id="modalWhen"></span></p>
      <p><span class="label">Location:</span> <span id="modalLocation"></span></p>
      <p><span class="label">Description:</span></p>
      <p id="modalDescription"></p>
    </div>
    <div class="modal-footer">
      <button class="btn" id="modalOkBtn">Close</button>
    </div>
  </div>
</div>

<script>
  const R2_BASE = 'https://pub-577ff589d29c4ebe9d2ea393dcf228f1.r2.dev';
  const WP1_ICS_URL = `${R2_BASE}/wp1.ics`;
  const HOLIDAYS_ICS_URL = `${R2_BASE}/holidays.ics`;

  // Active link highlight in nav
  (function markActiveNav() {
    const path = (window.location.pathname.split('/').pop() || '').toLowerCase();
    document.querySelectorAll('.wp-nav a').forEach(a => {
      const href = (a.getAttribute('href') || '').toLowerCase();
      if (href === path) a.classList.add('active');
    });
  })();

  // Small iCalendar (ICS) parser -> FullCalendar events
  function parseICS(icsText) {
    const rawLines = icsText.split(/\r?\n/);
    const lines = [];
    // Unfold lines (handle lines that start with space / tab)
    for (let i = 0; i < rawLines.length; i++) {
      const line = rawLines[i];
      if (!line) continue;
      if (line.startsWith(' ') || line.startsWith('\t')) {
        if (lines.length > 0) lines[lines.length - 1] += line.slice(1);
      } else {
        lines.push(line);
      }
    }

    const vevents = [];
    let current = null;

    for (const line of lines) {
      if (line.startsWith('BEGIN:VEVENT')) { current = {}; continue; }
      if (line.startsWith('END:VEVENT')) { if (current) vevents.push(current); current = null; continue; }
      if (!current) continue;

      const parts = line.split(':');
      if (parts.length < 2) continue;
      const value = parts.slice(1).join(':');
      const keyWithParams = parts[0];
      const key = keyWithParams.split(';')[0].toUpperCase();

      if (key === 'SUMMARY') current.summary = value;
      if (key === 'DESCRIPTION') current.description = value.replace(/\\n/g, '\n');
      if (key === 'LOCATION') current.location = value;
      if (key === 'DTSTART') current.dtstart = value;
      if (key === 'DTEND') current.dtend = value;
    }

    function parseICSTime(v) {
      if (!v) return null;

      // All-day date (YYYYMMDD)
      if (v.length === 8 && !v.includes('T')) {
        const y = parseInt(v.slice(0,4), 10);
        const m = parseInt(v.slice(4,6), 10) - 1;
        const d = parseInt(v.slice(6,8), 10);
        return { date: new Date(y, m, d), allDay: true };
      }

      // Date-time, optionally with Z
      const y = parseInt(v.slice(0,4), 10);
      const m = parseInt(v.slice(4,6), 10) - 1;
      const d = parseInt(v.slice(6,8), 10);
      const hh = parseInt(v.slice(9,11) || '0', 10);
      const mm = parseInt(v.slice(11,13) || '0', 10);
      const ss = parseInt(v.slice(13,15) || '0', 10);

      if (v.endsWith('Z')) {
        return { date: new Date(Date.UTC(y, m, d, hh, mm, ss)), allDay: false };
      }
      return { date: new Date(y, m, d, hh, mm, ss), allDay: false };
    }

    const events = vevents.map(ev => {
      const startParsed = parseICSTime(ev.dtstart);
      const endParsed = parseICSTime(ev.dtend);
      const allDay = startParsed ? startParsed.allDay : false;

      return {
        title: ev.summary || '(no title)',
        start: startParsed ? startParsed.date : null,
        end: endParsed ? endParsed.date : null,
        allDay: allDay,
        extendedProps: {
          description: ev.description || '',
          location: ev.location || ''
        }
      };
    });

    return events.filter(e => e.start);
  }

  function formatDateRange(start, end, allDay) {
    if (!start) return 'Unknown';
    const optionsDate = { year: 'numeric', month: 'short', day: 'numeric' };
    const optionsTime = { hour: '2-digit', minute: '2-digit' };

    if (allDay) {
      if (end) {
        return start.toLocaleDateString(undefined, optionsDate) +
               ' ‚Äì ' +
               end.toLocaleDateString(undefined, optionsDate);
      }
      return start.toLocaleDateString(undefined, optionsDate) + ' (all day)';
    }

    let text = start.toLocaleDateString(undefined, optionsDate) +
               ' ' +
               start.toLocaleTimeString(undefined, optionsTime);

    if (end) text += ' ‚Äì ' + end.toLocaleTimeString(undefined, optionsTime);
    return text;
  }

  async function loadICS(url, className) {
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('HTTP ' + resp.status + ' for ' + url);
    const text = await resp.text();
    const events = parseICS(text);
    events.forEach(e => e.classNames = (e.classNames || []).concat([className]));
    return events;
  }

  document.addEventListener('DOMContentLoaded', async function() {
    const calendarEl = document.getElementById('calendar');
    const statusEl = document.getElementById('status');

    // Modal elements
    const modalBackdrop = document.getElementById('eventModalBackdrop');
    const modalTitle = document.getElementById('modalTitle');
    const modalWhen = document.getElementById('modalWhen');
    const modalLocation = document.getElementById('modalLocation');
    const modalDescription = document.getElementById('modalDescription');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalOkBtn = document.getElementById('modalOkBtn');

    function closeModal() { modalBackdrop.classList.remove('show'); }
    modalCloseBtn.addEventListener('click', closeModal);
    modalOkBtn.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', function(e) {
      if (e.target === modalBackdrop) closeModal();
    });

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listYear',
      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek,listYear,multiMonthYear'
      },
      views: {
        listYear: { buttonText: 'Year list' },
        multiMonthYear: { buttonText: 'Year grid' }
      },

      // Add CSS class based on [Label] in the event title.
      // If event already has cat-holiday, we leave it intact.
      eventClassNames: function(info) {
        const existing = info.event.classNames || [];
        if (existing.includes('cat-holiday')) return [];

        const title = info.event.title || '';
        const match = title.match(/^\[(.*?)\]/);
        if (!match) return [];

        const label = match[1].trim();
        const safe = label.toLowerCase().replace(/\s+/g, '-');
        return [ 'cat-' + safe ];
      },

      eventClick: function(info) {
        const desc = info.event.extendedProps.description || 'No description provided.';
        const loc = info.event.extendedProps.location || 'Not specified';
        const when = formatDateRange(info.event.start, info.event.end, info.event.allDay);

        modalTitle.textContent = info.event.title;
        modalWhen.textContent = when;
        modalLocation.textContent = loc;
        modalDescription.textContent = desc;

        modalBackdrop.classList.add('show');
      }
    });

    calendar.render();

    // Load WP1 + holidays
    statusEl.classList.remove('error');
    statusEl.textContent = 'Loading WP1 calendar and holidays‚Ä¶';

    let holidaysSource = null;

    try {
      const wp1Events = await loadICS(WP1_ICS_URL, 'src-wp1');
      calendar.addEventSource(wp1Events);

      const holEvents = await loadICS(HOLIDAYS_ICS_URL, 'cat-holiday');
      holidaysSource = { id: 'holidays', events: holEvents };
      calendar.addEventSource(holidaysSource);

      statusEl.textContent = `WP1 loaded (${wp1Events.length} items) + holidays (${holEvents.length}).`;
    } catch (err) {
      console.error(err);
      statusEl.textContent = 'Could not load WP1 calendar ‚Äì please check the ICS URL or CORS settings.';
      statusEl.classList.add('error');
    }

    // Holidays toggle
    document.getElementById('toggleHolidays').addEventListener('change', (e) => {
      const src = calendar.getEventSourceById('holidays');
      if (e.target.checked) {
        if (!src && holidaysSource) calendar.addEventSource(holidaysSource);
      } else {
        if (src) src.remove();
      }
    });
  });
</script>

</body>
</html>
